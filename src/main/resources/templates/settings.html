<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/layout :: head('설정 - APIsis')}">
</head>
<head>
    <link rel="stylesheet" th:href="@{/css/settings.css}">
</head>
<body class="light-mode">
    <!-- 사이드바 -->
    <aside th:replace="~{fragments/layout :: sidebar}"></aside>

    <!-- 오버레이 (모바일용) -->
    <div th:replace="~{fragments/layout :: overlay}"></div>

    <!-- 메인 콘텐츠 -->
    <div class="main-content">
        <!-- 모바일 헤더 -->
        <header th:replace="~{fragments/layout :: header}"></header>

        <!-- 콘텐츠 래퍼 -->
        <div class="content-wrapper">
            <!-- 페이지 헤더 -->
            <div class="page-header mb-4">
                <h1 class="page-title">설정</h1>
                <p class="page-subtitle">계정 및 서비스 설정을 관리하세요</p>
            </div>

            <!-- 계정 설정 -->
            <div class="settings-card">
                <div class="settings-header">
                    <h2 class="settings-title">계정 설정</h2>
                    <p class="settings-subtitle">계정 정보 및 보안 설정</p>
                </div>

                <div class="settings-content">
                    <!-- 계정 정보 -->
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">이름</div>
                            <div class="setting-value" th:text="${user.name}">사용자</div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">이메일</div>
                            <div class="setting-value" th:text="${user.email}">user@example.com</div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">연결된 로그인 방식</div>
                            <div class="setting-value">
                                <span th:each="provider : ${userProviders}"
                                      class="provider-badge"
                                      th:classappend="${(provider == 'KAKAO' ? 'kakao' : (provider == 'GITHUB' ? 'github' : 'google')) + ' ' + (provider == loginProvider ? 'active' : '')}"
                                      th:text="${provider}"
                                      style="margin-right: 12px;">KAKAO</span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">가입일</div>
                            <div class="setting-value" th:text="${#temporals.format(user.createdDate, 'yyyy년 MM월 dd일')}">2024년 01월 01일</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 라이센스 설정 -->
            <div class="settings-card">
                <div class="settings-header">
                    <h2 class="settings-title">라이센스 관리</h2>
                    <p class="settings-subtitle">라이센스 등록 및 관리</p>
                </div>

                <div class="settings-content">
                    <div class="setting-item" th:if="${user.license != null}">
                        <div class="setting-info">
                            <div class="setting-label">현재 라이센스</div>
                            <div class="setting-value">
                                <span class="license-key" th:text="${user.license.id}">xxxx-xxxx-xxxx-xxxx</span>
                            </div>
                        </div>
                        <button class="btn-request" onclick="showRegisterLicenseModal()">변경</button>
                    </div>

                    <div class="setting-item" th:if="${user.license == null}">
                        <div class="setting-info">
                            <div class="setting-label">라이센스 등록</div>
                            <div class="setting-desc">xxxx-xxxx-xxxx-xxxx 형태의 라이센스 키를 입력하세요</div>
                        </div>
                        <button class="btn-request" onclick="showRegisterLicenseModal()">등록</button>
                    </div>

                    <div class="setting-item" th:if="${user.license != null}">
                        <div class="setting-info">
                            <div class="setting-label">플랜</div>
                            <div class="setting-value">
                                <span th:if="${user.license.paymentType.name() == 'EXTRA'}" th:text="${user.license.paymentType.name()}">EXTRA</span>
                                <span th:if="${user.license.paymentType.name() != 'EXTRA'}">
                                    <span th:text="${#strings.substringBefore(user.license.paymentType.name(), '_')}">BASIC</span>
                                    <span> / </span>
                                    <span th:text="${#strings.substringAfter(user.license.paymentType.name(), '_') == 'MONTH' ? '월' : '년'}">월</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item" th:if="${user.license != null && user.license.expiredDate != null}">
                        <div class="setting-info">
                            <div class="setting-label">만료일</div>
                            <div class="setting-value">
                                <span th:classappend="${#temporals.createNow().isAfter(user.license.expiredDate)} ? 'license-expired' : (${#temporals.createNow().plusDays(3).isAfter(user.license.expiredDate)} ? 'license-warning' : '')"
                                      th:text="${#temporals.format(user.license.expiredDate, 'yyyy년 MM월 dd일 HH시 mm분')}">2025년 01월 01일 00시 00분</span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item" th:if="${user.license != null && user.license.paymentType.name() == 'EXTRA'}">
                        <div class="setting-info">
                            <div class="setting-label">만료일</div>
                            <div class="setting-value">무제한</div>
                        </div>
                    </div>

                    <div class="setting-item" th:if="${user.license != null}">
                        <div class="setting-info">
                            <div class="setting-label">라이센스 해제</div>
                            <div class="setting-desc">라이센스를 해제하면 무료 플랜으로 전환됩니다</div>
                        </div>
                        <button class="btn-danger" onclick="showUnregisterLicenseModal()">해제</button>
                    </div>
                </div>
            </div>

            <!-- 분석 설정 -->
            <div class="settings-card">
                <div class="settings-header">
                    <h2 class="settings-title">분석 설정</h2>
                    <p class="settings-subtitle">API 사용 분석 설정</p>
                </div>

                <div class="settings-content">
                    <div class="setting-item">
                        <div class="setting-info">
                            <div class="setting-label">분석 활성화</div>
                            <div class="setting-desc">API 사용 패턴 분석 및 정기 리포트 수신</div>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="analyticsEnabled"
                                   th:checked="${analyticsSetting != null && analyticsSetting.enabled}">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>

                    <div class="setting-item" id="analyticsRangeItem">
                        <div class="setting-info">
                            <div class="setting-label">분석 주기</div>
                            <div class="setting-desc">정기 분석 리포트 생성 주기</div>
                        </div>
                        <select id="analyticsRange" class="setting-select">
                            <option value="DAY" th:selected="${analyticsSetting?.dateRange?.name() == 'DAY'}">일</option>
                            <option value="WEEK" th:selected="${analyticsSetting?.dateRange?.name() == 'WEEK'}">주</option>
                            <option value="MONTH" th:selected="${analyticsSetting?.dateRange?.name() == 'MONTH'}">개월</option>
                        </select>
                    </div>

                    <div class="setting-item" id="nextAnalyticsDateItem">
                        <div class="setting-info">
                            <div class="setting-label">다음 분석 예정일</div>
                            <div class="setting-value" id="nextAnalyticsDate"
                                 th:text="${analyticsSetting != null ? #temporals.format(analyticsSetting.nextAnalyticsDate, 'yyyy년 MM월 dd일') : '-'}">-</div>
                        </div>
                        <button class="btn-request" id="requestAnalyticsBtn" onclick="requestAnalytics()"
                                th:disabled="${analyticsSetting != null && #temporals.format(analyticsSetting.nextAnalyticsDate, 'yyyy-MM-dd') == #temporals.format(#temporals.createToday(), 'yyyy-MM-dd')}">
                            오늘 분석 요청
                        </button>
                    </div>
                </div>
            </div>

            <!-- 위험 구역 -->
            <div class="danger-zone-card">
                <div class="danger-header">
                    <h2 class="danger-title">위험 구역</h2>
                    <p class="danger-subtitle">돌이킬 수 없는 작업입니다. 신중하게 진행해주세요.</p>
                </div>

                <div class="danger-content">
                    <div class="danger-item">
                        <div class="danger-info">
                            <div class="danger-item-title">API 키 전체 삭제</div>
                            <div class="danger-item-desc">
                                생성한 모든 API 키가 영구적으로 삭제됩니다.<br>
                                • 모든 API 키가 즉시 비활성화됩니다<br>
                                • 해당 키를 사용하는 모든 서비스가 중단됩니다<br>
                                • 이 작업은 되돌릴 수 없습니다
                            </div>
                        </div>
                        <button class="btn-danger" onclick="showDeleteAllApiKeysModal()">API 키 전체 삭제</button>
                    </div>

                    <div class="danger-item">
                        <div class="danger-info">
                            <div class="danger-item-title">분석 보고서 전체 삭제</div>
                            <div class="danger-item-desc">
                                생성된 모든 분석 보고서가 영구적으로 삭제됩니다.<br>
                                • 과거 분석 데이터를 모두 잃게 됩니다<br>
                                • 분석 설정은 유지됩니다<br>
                                • 이 작업은 되돌릴 수 없습니다
                            </div>
                        </div>
                        <button class="btn-danger" onclick="showDeleteAllAnalyticsModal()">분석 보고서 전체 삭제</button>
                    </div>

                    <div class="danger-item">
                        <div class="danger-info">
                            <div class="danger-item-title">계정 탈퇴</div>
                            <div class="danger-item-desc">
                                계정을 탈퇴하면 모든 데이터가 영구적으로 삭제됩니다.<br>
                                • 계정과 관련한 모든 정보가 삭제됩니다<br>
                                • 사용중인 라이센스는 다른 계정에서 이어서 사용할 수 있으나 유실될 수 있습니다<br>
                                • 이 작업은 되돌릴 수 없습니다
                            </div>
                        </div>
                        <button class="btn-danger" onclick="showDeleteAccountModal()">계정 탈퇴</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API 키 전체 삭제 확인 모달 -->
    <div id="deleteAllApiKeysModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>API 키 전체 삭제 확인</h3>
                <button class="modal-close" onclick="closeDeleteAllApiKeysModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-box">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-text">
                        <strong>이 작업은 되돌릴 수 없습니다!</strong><br>
                        모든 API 키가 영구적으로 삭제됩니다.
                    </div>
                </div>
                <p style="margin-top: 20px; color: #666; font-size: 14px;">
                    정말로 모든 API 키를 삭제하시겠습니까?
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeleteAllApiKeysModal()">취소</button>
                <button class="btn-danger" onclick="deleteAllApiKeys()">전체 삭제</button>
            </div>
        </div>
    </div>

    <!-- 분석 보고서 전체 삭제 확인 모달 -->
    <div id="deleteAllAnalyticsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>분석 보고서 전체 삭제 확인</h3>
                <button class="modal-close" onclick="closeDeleteAllAnalyticsModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-box">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-text">
                        <strong>이 작업은 되돌릴 수 없습니다!</strong><br>
                        모든 분석 보고서가 영구적으로 삭제됩니다.
                    </div>
                </div>
                <p style="margin-top: 20px; color: #666; font-size: 14px;">
                    정말로 모든 분석 보고서를 삭제하시겠습니까?
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeleteAllAnalyticsModal()">취소</button>
                <button class="btn-danger" onclick="deleteAllAnalytics()">전체 삭제</button>
            </div>
        </div>
    </div>

    <!-- 계정 탈퇴 확인 모달 -->
    <div id="deleteAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>계정 탈퇴 확인</h3>
                <button class="modal-close" onclick="closeDeleteAccountModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-box">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-text">
                        <strong>이 작업은 되돌릴 수 없습니다!</strong><br>
                        계정을 탈퇴하면 모든 데이터가 영구적으로 삭제됩니다.
                    </div>
                </div>
                <p style="margin-top: 20px; color: #666; font-size: 14px;">
                    정말로 계정을 탈퇴하시겠습니까?<br>
                    탈퇴를 진행하려면 아래 "계정 탈퇴" 버튼을 클릭해주세요.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeDeleteAccountModal()">취소</button>
                <button class="btn-danger" onclick="deleteAccount()">계정 탈퇴</button>
            </div>
        </div>
    </div>

    <!-- 라이센스 등록 모달 -->
    <div id="registerLicenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>라이센스 등록</h3>
                <button class="modal-close" onclick="closeRegisterLicenseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: #666; font-size: 14px;">
                    라이센스 키를 입력해주세요
                </p>
                <input type="text" id="licenseKeyInput" class="license-input" placeholder="xxxx-xxxx-xxxx-xxxx" maxlength="19">
                <p id="licenseError" class="error-message" style="display: none; color: #e74c3c; margin-top: 10px; font-size: 14px;"></p>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeRegisterLicenseModal()">취소</button>
                <button class="btn-primary" onclick="registerLicense()">등록</button>
            </div>
        </div>
    </div>

    <!-- 라이센스 해제 확인 모달 -->
    <div id="unregisterLicenseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>라이센스 해제 확인</h3>
                <button class="modal-close" onclick="closeUnregisterLicenseModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="warning-box">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-text">
                        <strong>라이센스를 해제하시겠습니까?</strong><br>
                        무료 플랜으로 전환되며, 일부 기능이 제한됩니다.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeUnregisterLicenseModal()">취소</button>
                <button class="btn-danger" onclick="unregisterLicense()">해제</button>
            </div>
        </div>
    </div>

    <!-- 스크립트 -->
    <th:block th:replace="~{fragments/layout :: scripts}"></th:block>
    <script th:src="@{/js/settings.js}"></script>
</body>
</html>
